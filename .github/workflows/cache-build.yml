name: 使用缓存编译

on:
  # push:
  schedule:
    - cron: "0 19 * * *"
  workflow_dispatch:
    inputs:
      ssh:
        description: "Debug Mode"
        required: true
        default: "false"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: ["n1"]
    env:
      MSG_PREFIX: "Ref: ${{ github.ref }}\nPlatform: ${{ matrix.platform }}\nCommit message: ${{ github.event.head_commit.message }}\n\n"
      REPO_URL: https://github.com/coolsnowwolf/lede
      REPO_BRANCH: master
      TZ: Asia/Shanghai

    steps:

      - name: Checkout
        uses: actions/checkout@main

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo timedatectl set-timezone "$TZ"

          sudo -E swapoff -a

          sudo rm -rf /etc/apt/sources.list.d/*

          sudo add-apt-repository ppa:bashtop-monitor/bashtop

          sudo -E apt-get -qq update
          sudo -E apt-get -qq install bashtop rclone build-essential asciidoc binutils bzip2 gawk gettext git libncurses5-dev libz-dev patch unzip zlib1g-dev lib32gcc1 libc6-dev-i386 subversion flex uglifyjs gcc-multilib g++-multilib p7zip p7zip-full msmtp libssl-dev texinfo libglib2.0-dev xmlto qemu-utils upx libelf-dev autoconf automake libtool autopoint device-tree-compiler antlr3 gperf wget swig rsync

          rm -rf ~/.config/rclone
          mkdir -p ~/.config/rclone
          # 下载配置
          curl -Lo ~/.config/rclone/rclone.conf "${{secrets.RCLONE_CONFIG_LINK}}"


          # docker rmi `docker images -q`

          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /etc/mysql /etc/php /swapfile
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean

          echo "==> 安装starship"
          curl -fsSLO https://starship.rs/install.sh  && bash ./install.sh --yes
          rm ./install.sh
          echo "==> 写入bash配置文件"
          echo 'eval "$(starship init bash)"' >> ~/.bashrc
          source ~/.bashrc



      - name: 下载编译缓存
        run: |
          
          rclone copy github-action:/openwrt/n1/op-build-cache.tar .

          tar xf op-build-cache.tar
          rm -f op-build-cache.tar



      - name: Storage Spaces
        run: |
          df -h /


      - name: Debug
        uses: mxschmitt/action-tmate@v3
        if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')


      - name: Compile the firmware
        run: |
          cd openwrt
          make -j$(($(nproc) + 1)) || make -j$(($(nproc) + 1)) V=s

      - name: Storage Spaces
        run: |
          df -h /

#      - name: 上传编译缓存
#        run: |
#          cd openwrt
#          tar cf op-build-cache.tar ./build_dir/ --remove-files
#          rclone copy op-build-cache.tar github-action:/openwrt/n1/
#
#      - name: Organize files
#        if: ${{ !contains(matrix.platform, 'n1') }}
#        run: |
#          cd openwrt/bin/targets/*/*
#          rm -rf packages
#
#          echo "PACKAGED_OUTPUTPATH=$PWD" >> $GITHUB_ENV
#
#      - name: Package Armvirt as OpenWrt
#        if: contains(matrix.platform, 'n1')
#        uses: ophub/flippy-openwrt-actions@main
#        env:
#          OPENWRT_ARMVIRT: openwrt/bin/targets/*/*/*.tar.gz
#          PACKAGE_SOC: s905d
#          KERNEL_VERSION_NAME: 5.4.130
#
#      - name: Upload firmware
#        run: |
#          # 删除tar.gz
#          rm -f /opt/openwrt_packit/tmp/openwrt-armvirt-64-default-rootfs.tar.gz
#
#          curl -fsSL git.io/file-transfer | sh
#          ./transfer cow --block 2621440 -s -p 64 --no-progress ${PACKAGED_OUTPUTPATH} 2>&1 | tee cowtransfer.log
#          echo "DOWNLOAD_LINK=$(cat cowtransfer.log | grep https | cut -f3 -d" ")" >> $GITHUB_ENV
#
#          rclone copy ${{ env.PACKAGED_OUTPUTPATH }}/* github-action:/openwrt/n1/
#
#      - name: TG Notification - ❌
#        if: ${{ !success() }}
#        run: |
#          curl -sX POST \
#          -H 'Content-Type: application/json' \
#          -d '{"chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}", "text": "${{ env.MSG_PREFIX }} ❌ Build failed or canceled"}' \
#          https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage >> /dev/null
#
#      - name: TG Notification - ✔️
#        if: ${{ success() }}
#        run: |
#          curl -sX POST \
#          -H 'Content-Type: application/json' \
#          -d '{"chat_id": "${{ secrets.TELEGRAM_CHAT_ID }}", "text": "${{ env.MSG_PREFIX }} ✔️ ${{ env.DOWNLOAD_LINK }}"}' \
#          https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage >> /dev/null
